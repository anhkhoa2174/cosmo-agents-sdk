openapi: 3.0.3
info:
  title: Configurable Agent System API
  version: 1.0.0
  description: REST API for managing configurable AI agents with personas, skills, and approval workflows

servers:
  - url: /api/v1
    description: API v1

security:
  - bearerAuth: []

paths:
  # Agent Management
  /agents:
    get:
      summary: List agents
      operationId: listAgents
      tags: [Agents]
      parameters:
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of agents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentList'
    post:
      summary: Create agent
      operationId: createAgent
      tags: [Agents]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAgentRequest'
      responses:
        '201':
          description: Agent created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '400':
          $ref: '#/components/responses/ValidationError'

  /agents/{agentId}:
    get:
      summary: Get agent by ID
      operationId: getAgent
      tags: [Agents]
      parameters:
        - $ref: '#/components/parameters/agentId'
      responses:
        '200':
          description: Agent details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update agent
      operationId: updateAgent
      tags: [Agents]
      parameters:
        - $ref: '#/components/parameters/agentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAgentRequest'
      responses:
        '200':
          description: Agent updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
    delete:
      summary: Delete agent
      operationId: deleteAgent
      tags: [Agents]
      parameters:
        - $ref: '#/components/parameters/agentId'
      responses:
        '204':
          description: Agent deleted

  /agents/{agentId}/skills:
    put:
      summary: Update agent skills
      operationId: updateAgentSkills
      tags: [Agents]
      parameters:
        - $ref: '#/components/parameters/agentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [skill_ids]
              properties:
                skill_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
      responses:
        '200':
          description: Skills updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'

  # Persona Management
  /personas:
    get:
      summary: List personas
      operationId: listPersonas
      tags: [Personas]
      responses:
        '200':
          description: List of personas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonaList'
    post:
      summary: Create persona
      operationId: createPersona
      tags: [Personas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePersonaRequest'
      responses:
        '201':
          description: Persona created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Persona'

  /personas/{personaId}:
    get:
      summary: Get persona by ID
      operationId: getPersona
      tags: [Personas]
      parameters:
        - $ref: '#/components/parameters/personaId'
      responses:
        '200':
          description: Persona details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Persona'
    patch:
      summary: Update persona
      operationId: updatePersona
      tags: [Personas]
      parameters:
        - $ref: '#/components/parameters/personaId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePersonaRequest'
      responses:
        '200':
          description: Persona updated
    delete:
      summary: Delete persona
      operationId: deletePersona
      tags: [Personas]
      parameters:
        - $ref: '#/components/parameters/personaId'
      responses:
        '204':
          description: Persona deleted

  # Skill Management
  /skills:
    get:
      summary: List available skills
      operationId: listSkills
      tags: [Skills]
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: is_automatable
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of skills
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkillList'

  # Session Management
  /agents/{agentId}/sessions:
    post:
      summary: Start new session
      operationId: startSession
      tags: [Sessions]
      parameters:
        - $ref: '#/components/parameters/agentId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                metadata:
                  type: object
      responses:
        '201':
          description: Session started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'

  /sessions/{sessionId}:
    get:
      summary: Get session
      operationId: getSession
      tags: [Sessions]
      parameters:
        - $ref: '#/components/parameters/sessionId'
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'

  /sessions/{sessionId}/chat:
    post:
      summary: Send message to agent
      operationId: chat
      tags: [Sessions]
      parameters:
        - $ref: '#/components/parameters/sessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message]
              properties:
                message:
                  type: string
                  maxLength: 10000
      responses:
        '200':
          description: Agent response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /sessions/{sessionId}/end:
    post:
      summary: End session
      operationId: endSession
      tags: [Sessions]
      parameters:
        - $ref: '#/components/parameters/sessionId'
      responses:
        '200':
          description: Session ended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'

  # Output Management
  /outputs:
    get:
      summary: List outputs
      operationId: listOutputs
      tags: [Outputs]
      parameters:
        - name: agent_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/OutputStatus'
        - name: from_date
          in: query
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          schema:
            type: string
            format: date
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of outputs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputList'

  /outputs/{outputId}:
    get:
      summary: Get output by ID
      operationId: getOutput
      tags: [Outputs]
      parameters:
        - $ref: '#/components/parameters/outputId'
      responses:
        '200':
          description: Output details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Output'

  /outputs/{outputId}/content:
    get:
      summary: Get output content (presigned URL redirect)
      operationId: getOutputContent
      tags: [Outputs]
      parameters:
        - $ref: '#/components/parameters/outputId'
      responses:
        '302':
          description: Redirect to presigned S3 URL
          headers:
            Location:
              schema:
                type: string
                format: uri

  /outputs/{outputId}/approve:
    post:
      summary: Approve output
      operationId: approveOutput
      tags: [Outputs]
      parameters:
        - $ref: '#/components/parameters/outputId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                auto_execute:
                  type: boolean
                  default: false
                notes:
                  type: string
                  maxLength: 1000
      responses:
        '200':
          description: Output approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Output'
        '409':
          description: Output already decided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /outputs/{outputId}/reject:
    post:
      summary: Reject output
      operationId: rejectOutput
      tags: [Outputs]
      parameters:
        - $ref: '#/components/parameters/outputId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notes:
                  type: string
                  maxLength: 1000
      responses:
        '200':
          description: Output rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Output'
        '409':
          description: Output already decided

  # Memory Management
  /agents/{agentId}/memory:
    get:
      summary: Get agent memory entries
      operationId: getAgentMemory
      tags: [Memory]
      parameters:
        - $ref: '#/components/parameters/agentId'
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
        - name: query
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Memory entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryList'
    delete:
      summary: Clear agent memory
      operationId: clearAgentMemory
      tags: [Memory]
      parameters:
        - $ref: '#/components/parameters/agentId'
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Memory cleared

  # Webhook Callback (for external systems)
  /webhooks/approval:
    post:
      summary: Approval callback from external system
      operationId: webhookApproval
      tags: [Webhooks]
      security:
        - webhookAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [output_id, decision, token]
              properties:
                output_id:
                  type: string
                  format: uuid
                decision:
                  type: string
                  enum: [approved, rejected]
                token:
                  type: string
                auto_execute:
                  type: boolean
                notes:
                  type: string
      responses:
        '200':
          description: Decision recorded
        '401':
          description: Invalid token
        '409':
          description: Already decided

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    webhookAuth:
      type: apiKey
      in: header
      name: X-Webhook-Signature

  parameters:
    agentId:
      name: agentId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    personaId:
      name: personaId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    sessionId:
      name: sessionId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    outputId:
      name: outputId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Daily output limit reached for agent Enterprise Sales Bot. Resets at 2025-01-26T00:00:00Z"
              reset_at:
                type: string
                format: date-time

  schemas:
    Agent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        persona_id:
          type: string
          format: uuid
        persona:
          $ref: '#/components/schemas/Persona'
        system_prompt:
          type: string
        skill_ids:
          type: array
          items:
            type: string
            format: uuid
        skills:
          type: array
          items:
            $ref: '#/components/schemas/Skill'
        knowledge_base_id:
          type: string
          format: uuid
        memory_config:
          $ref: '#/components/schemas/MemoryConfig'
        daily_output_limit:
          type: integer
        webhook_url:
          type: string
          format: uri
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AgentList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Agent'
        next_cursor:
          type: string

    CreateAgentRequest:
      type: object
      required: [name, persona_id, system_prompt, skill_ids, memory_config]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
        persona_id:
          type: string
          format: uuid
        system_prompt:
          type: string
          minLength: 1
          maxLength: 10000
        skill_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
        knowledge_base_id:
          type: string
          format: uuid
        memory_config:
          $ref: '#/components/schemas/MemoryConfig'
        daily_output_limit:
          type: integer
          default: 100
          minimum: 1
          maximum: 1000
        webhook_url:
          type: string
          format: uri
        webhook_secret:
          type: string
          minLength: 32

    UpdateAgentRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        persona_id:
          type: string
          format: uuid
        system_prompt:
          type: string
        knowledge_base_id:
          type: string
          format: uuid
        memory_config:
          $ref: '#/components/schemas/MemoryConfig'
        daily_output_limit:
          type: integer
        webhook_url:
          type: string
          format: uri
        is_active:
          type: boolean

    Persona:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        role:
          type: string
        communication_style:
          type: string
        tone:
          type: string
        target_audience:
          type: string
        signature_elements:
          type: array
          items:
            type: string
        example_messages:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PersonaList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Persona'

    CreatePersonaRequest:
      type: object
      required: [name, role, communication_style, tone, target_audience]
      properties:
        name:
          type: string
        role:
          type: string
        communication_style:
          type: string
        tone:
          type: string
        target_audience:
          type: string
        signature_elements:
          type: array
          items:
            type: string
        example_messages:
          type: array
          items:
            type: string

    UpdatePersonaRequest:
      type: object
      properties:
        name:
          type: string
        role:
          type: string
        communication_style:
          type: string
        tone:
          type: string
        target_audience:
          type: string
        signature_elements:
          type: array
          items:
            type: string
        example_messages:
          type: array
          items:
            type: string

    Skill:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        display_name:
          type: string
        description:
          type: string
        category:
          type: string
        is_automatable:
          type: boolean
        is_system:
          type: boolean

    SkillList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Skill'

    MemoryConfig:
      type: object
      required: [provider, scope]
      properties:
        provider:
          type: string
          enum: [mem0, in-memory]
          default: mem0
        scope:
          type: string
          enum: [agent, user, session, prospect]
          default: user
        retention_days:
          type: integer
          minimum: 1
          maximum: 365
        config:
          type: object

    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
        agent_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
        message_count:
          type: integer
        output_count:
          type: integer

    ChatResponse:
      type: object
      properties:
        message:
          type: string
        outputs:
          type: array
          items:
            $ref: '#/components/schemas/Output'
        tools_used:
          type: array
          items:
            type: string

    Output:
      type: object
      properties:
        id:
          type: string
          format: uuid
        agent_id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        content_type:
          type: string
          enum: [text, json, file]
        content_preview:
          type: string
        status:
          $ref: '#/components/schemas/OutputStatus'
        skill_used:
          type: string
        is_automatable:
          type: boolean
        approval:
          $ref: '#/components/schemas/ApprovalRecord'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    OutputStatus:
      type: string
      enum: [pending, approved, rejected, executed, manual, notification_failed]

    OutputList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Output'
        next_cursor:
          type: string

    ApprovalRecord:
      type: object
      properties:
        id:
          type: string
          format: uuid
        decision:
          type: string
          enum: [approved, rejected]
        decided_by:
          type: string
          format: uuid
        decided_at:
          type: string
          format: date-time
        notes:
          type: string
        auto_execute:
          type: boolean

    MemoryEntry:
      type: object
      properties:
        id:
          type: string
        content:
          type: string
        created_at:
          type: string
          format: date-time

    MemoryList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MemoryEntry'

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string

    ValidationError:
      type: object
      properties:
        error:
          type: string
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
